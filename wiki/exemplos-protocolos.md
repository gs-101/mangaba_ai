# üåê Exemplos dos Protocolos A2A e MCP

Este guia fornece exemplos pr√°ticos e detalhados dos protocolos A2A (Agent-to-Agent) e MCP (Model Context Protocol) utilizados no Mangaba AI.

## üìã √çndice

1. [Protocolo MCP](#-protocolo-mcp)
2. [Protocolo A2A](#-protocolo-a2a)
3. [Integra√ß√£o dos Protocolos](#-integra√ß√£o-dos-protocolos)
4. [Casos de Uso Avan√ßados](#-casos-de-uso-avan√ßados)
5. [Troubleshooting](#-troubleshooting)

---

## üß† Protocolo MCP

O **Model Context Protocol (MCP)** gerencia o contexto e a mem√≥ria dos agentes de forma inteligente e estruturada.

### Exemplo B√°sico - Chat com Contexto

```python
from mangaba_ai import MangabaAI
import asyncio

async def exemplo_mcp_basico():
    # Inicializa o agente com MCP
    ai = MangabaAI()
    agent = ai.create_agent(
        name="assistente",
        role="Assistente Pessoal",
        goal="Ajudar com tarefas diversas mantendo contexto"
    )
    
    # Primeira intera√ß√£o - estabelece contexto
    resposta1 = await agent.chat("Ol√°! Estou aprendendo Python.")
    print(f"Agente: {resposta1}")
    
    # Segunda intera√ß√£o - usa contexto anterior
    resposta2 = await agent.chat("Que bibliotecas voc√™ recomenda?")
    print(f"Agente: {resposta2}")
    # Resultado: "Para Python, recomendo pandas, numpy e matplotlib..."
```

### Gerenciamento de Sess√µes MCP

```python
async def exemplo_sessoes_mcp():
    ai = MangabaAI()
    agent = ai.create_agent(name="multi_user", role="Atendente")
    
    # Sess√£o do usu√°rio A
    with agent.mcp_protocol.session("usuario_a") as sessao_a:
        await agent.chat("Sou Jo√£o, trabalho com vendas", session=sessao_a)
        resposta_a = await agent.chat("Qual meu nome?", session=sessao_a)
        print(f"Para Jo√£o: {resposta_a}")  # "Seu nome √© Jo√£o"
    
    # Sess√£o do usu√°rio B (contexto isolado)
    with agent.mcp_protocol.session("usuario_b") as sessao_b:
        await agent.chat("Sou Maria, trabalho com marketing", session=sessao_b)
        resposta_b = await agent.chat("Qual meu nome?", session=sessao_b)
        print(f"Para Maria: {resposta_b}")  # "Seu nome √© Maria"
```

### Resumo e Gest√£o de Contexto

```python
# Obter resumo do contexto atual
resumo = agent.get_context_summary()
print("üìù Resumo do Contexto:")
for tipo, dados in resumo.items():
    print(f"  {tipo}: {len(dados)} itens")

# Exemplo de sa√≠da:
# üìù Resumo do Contexto:
#   chat_history: 5 itens
#   analysis_results: 2 itens
#   user_profile: 1 itens
#   project_info: 1 itens

# Limpeza seletiva de contexto
agent.mcp_protocol.clear_context(context_type="chat_history")

# Exportar contexto para backup
contexto_backup = agent.mcp_protocol.export_context()
```

### Busca Sem√¢ntica no Contexto

```python
async def exemplo_busca_semantica():
    # Adiciona v√°rias informa√ß√µes ao contexto
    await agent.chat("Trabalho na empresa TechCorp desde 2020")
    await agent.chat("Meu projeto atual √© sobre IA generativa")
    await agent.chat("Tenho mestrado em Ci√™ncia da Computa√ß√£o")
    
    # Busca por informa√ß√µes relacionadas
    resultados = await agent.mcp_protocol.semantic_search(
        query="forma√ß√£o acad√™mica",
        limit=3
    )
    
    for resultado in resultados:
        print(f"üìö {resultado.content} (score: {resultado.relevance})")
    # Sa√≠da: "Tenho mestrado em Ci√™ncia da Computa√ß√£o (score: 0.85)"
```

---

## üîó Protocolo A2A

O **Agent-to-Agent Protocol (A2A)** permite comunica√ß√£o estruturada entre agentes.

### Comunica√ß√£o B√°sica Entre Agentes

```python
async def exemplo_a2a_basico():
    ai = MangabaAI()
    
    # Cria agentes especializados
    pesquisador = ai.create_agent(
        name="pesquisador",
        role="Researcher",
        goal="Coletar informa√ß√µes"
    )
    
    analista = ai.create_agent(
        name="analista", 
        role="Analyst",
        goal="Analisar dados"
    )
    
    # Pesquisador coleta dados
    dados = await pesquisador.research("tend√™ncias de IA em 2024")
    
    # Envia dados para o analista via A2A
    await pesquisador.send_message(
        receiver="analista",
        content=dados,
        message_type="research_data",
        priority=1
    )
    
    # Analista processa os dados recebidos
    analise = await analista.receive_and_process()
    print(f"üìä An√°lise: {analise}")
```

### Sistema de Mensagens com Prioridade

```python
async def exemplo_priorizacao_a2a():
    # Configura√ß√£o de handlers por prioridade
    async def handler_urgente(message):
        print(f"üö® URGENTE: {message.content}")
        # Processa imediatamente
        
    async def handler_normal(message):
        print(f"üìù Normal: {message.content}")
        # Adiciona √† fila de processamento
        
    async def handler_baixa(message):
        print(f"‚ÑπÔ∏è Info: {message.content}")
        # Processa quando h√° recursos dispon√≠veis
    
    # Registra handlers
    analista.a2a_protocol.register_handler(
        priority=3, handler=handler_urgente
    )
    analista.a2a_protocol.register_handler(
        priority=2, handler=handler_normal
    )
    analista.a2a_protocol.register_handler(
        priority=1, handler=handler_baixa
    )
    
    # Envia mensagens com diferentes prioridades
    await pesquisador.send_message(
        receiver="analista",
        content="Sistema fora do ar!",
        priority=3,  # Urgente
        ttl=300      # 5 minutos TTL
    )
```

### Broadcast para M√∫ltiplos Agentes

```python
async def exemplo_broadcast():
    # Cria equipe de agentes
    equipe = [
        ai.create_agent(name=f"agente_{i}", role="Worker")
        for i in range(3)
    ]
    
    coordenador = ai.create_agent(name="coordenador", role="Coordinator")
    
    # Coordenador envia tarefa para toda equipe
    await coordenador.broadcast_message(
        receivers=["agente_0", "agente_1", "agente_2"],
        content={
            "task": "analyze_document",
            "document_id": "doc_123",
            "deadline": "2024-01-15"
        },
        message_type="task_assignment"
    )
    
    # Coleta respostas de todos os agentes
    respostas = []
    for agente in equipe:
        resposta = await agente.receive_messages()
        if resposta:
            resultado = await agente.process_task(resposta[0])
            respostas.append(resultado)
    
    return respostas
```

### Sistema Multi-Agente Complexo

```python
class SistemaAnaliseDocumentos:
    def __init__(self):
        self.ai = MangabaAI()
        self.extrator = self.ai.create_agent(
            name="extrator", role="Text Extractor"
        )
        self.analisador = self.ai.create_agent(
            name="analisador", role="Content Analyzer"
        )
        self.sumarizador = self.ai.create_agent(
            name="sumarizador", role="Summarizer"
        )
    
    async def processar_documento(self, documento):
        # 1. Extra√ß√£o de texto
        await self.extrator.send_message(
            receiver="analisador",
            content={"raw_document": documento},
            message_type="extract_text"
        )
        
        # 2. An√°lise de conte√∫do
        texto_extraido = await self.analisador.receive_and_process()
        await self.analisador.send_message(
            receiver="sumarizador",
            content={"analyzed_text": texto_extraido},
            message_type="analyze_content"
        )
        
        # 3. Sumariza√ß√£o final
        relatorio_final = await self.sumarizador.receive_and_process()
        
        return relatorio_final

# Uso
sistema = SistemaAnaliseDocumentos()
documento = "Este √© um documento muito bom sobre IA..."
resultado = sistema.processar_documento(documento)
print(f"üìÑ Relat√≥rio: {resultado}")
```

---

## üîÑ Integra√ß√£o dos Protocolos

### Exemplo Completo: Sistema de Atendimento Inteligente

```python
class AtendimentoInteligente:
    def __init__(self):
        self.ai = MangabaAI()
        
        # Agente principal com MCP para contexto do cliente
        self.atendente = self.ai.create_agent(
            name="atendente",
            role="Customer Service",
            goal="Atender clientes com excel√™ncia"
        )
        
        # Agente especialista para casos complexos
        self.especialista = self.ai.create_agent(
            name="especialista",
            role="Technical Specialist",
            goal="Resolver problemas t√©cnicos"
        )
        
        # Supervisor para escalonamento
        self.supervisor = self.ai.create_agent(
            name="supervisor",
            role="Service Supervisor",
            goal="Garantir qualidade do atendimento"
        )
    
    async def atender_cliente(self, mensagem_cliente, historico_cliente=None):
        # 1. MCP: Carrega contexto do cliente
        if historico_cliente:
            await self.atendente.mcp_protocol.add_context(
                context_type="customer_history",
                content=historico_cliente
            )
        
        # 2. Atendimento inicial
        resposta_inicial = await self.atendente.chat(mensagem_cliente)
        
        # 3. A2A: Verifica se precisa de especialista
        if self.atendente.analysis.complexity_score > 0.7:
            await self.atendente.send_message(
                receiver="especialista",
                content={
                    "customer_message": mensagem_cliente,
                    "context": historico_cliente,
                    "initial_analysis": resposta_inicial
                },
                message_type="escalation_request",
                priority=2
            )
            
            resposta_especialista = await self.especialista.receive_and_process()
            
            # 4. A2A: Supervisor avalia a solu√ß√£o
            resposta = await self.supervisor.send_request(
                "Supervisor", "avaliar_caso",
                {"caso": mensagem_cliente, "contexto": historico_cliente}
            )
        
        return resposta

# Uso
atendimento = AtendimentoInteligente()
resposta = atendimento.atender_cliente(
    "Meu software n√£o est√° funcionando ap√≥s a atualiza√ß√£o",
    historico_cliente="Cliente premium h√° 2 anos, √∫ltima compra em dezembro"
)
```

---

## üöÄ Casos de Uso Avan√ßados

### 1. Sistema de Atendimento Multi-Agente

```python
class SistemaAtendimento:
    async def processar_ticket(self, ticket):
        # Triagem autom√°tica
        categoria = await self.triagem.classify(ticket.content)
        
        # Roteamento baseado em especializa√ß√£o
        agente_especializado = self.get_agente_by_category(categoria)
        
        # Processamento com contexto
        with agente_especializado.mcp_protocol.session(ticket.user_id):
            resposta = await agente_especializado.process(ticket)
        
        return resposta
```

### 2. Rede de Agentes de Pesquisa

```python
class RedeIAdePesquisa:
    def __init__(self):
        self.coordenador = self.create_coordinator()
        self.pesquisadores = self.create_research_team()
        self.sintetizador = self.create_synthesizer()
    
    async def pesquisar_topico(self, topico, profundidade="media"):
        # 1. Coordenador divide a pesquisa
        subtopicos = await self.coordenador.divide_research(topico)
        
        # 2. A2A: Distribui subt√≥picos para pesquisadores
        tarefas = []
        for i, subtopico in enumerate(subtopicos):
            pesquisador = self.pesquisadores[i % len(self.pesquisadores)]
            tarefa = pesquisador.research_async(subtopico)
            tarefas.append(tarefa)
        
        # 3. Coleta resultados
        resultados = await asyncio.gather(*tarefas)
        
        # 4. MCP: S√≠ntese com contexto completo
        await self.sintetizador.mcp_protocol.add_bulk_context(resultados)
        sintese_final = await self.sintetizador.synthesize(topico)
        
        return {
            "topico": topico,
            "resultados_individuais": resultados,
            "sintese": sintese_final
        }

# Uso
rede = RedeIAdePesquisa()
relatorio = rede.pesquisar_topico(
    "Impacto da IA Generativa no Mercado de Trabalho",
    profundidade="alta"
)
```

---

## üîç Troubleshooting

### Problemas Comuns MCP

#### **Contexto Perdido**
```python
# Diagn√≥stico
stats = agent.mcp_protocol.get_context_stats()
print(f"Contextos ativos: {stats}")

# Solu√ß√£o: Verificar TTL e limpeza autom√°tica
agent.mcp_protocol.set_context_ttl(seconds=3600)  # 1 hora
```

#### **Mem√≥ria Excessiva**
```python
# Limpar contextos antigos
agent.mcp_protocol.cleanup_expired_contexts()

# Configurar limpeza autom√°tica
agent.mcp_protocol.enable_auto_cleanup(interval=1800)  # 30 min
```

### Problemas Comuns A2A

#### **Mensagens Perdidas**
```python
# Verificar fila de mensagens
pending = agent.a2a_protocol.get_pending_messages()
print(f"Mensagens pendentes: {len(pending)}")

# Reprocessar mensagens perdidas
for msg in pending:
    await agent.a2a_protocol.retry_message(msg.id)
```

#### **Sobrecarga de Comunica√ß√£o**
```python
# Configurar rate limiting
agent.a2a_protocol.set_rate_limit(
    messages_per_minute=60,
    burst_size=10
)

# Prioriza√ß√£o inteligente
agent.a2a_protocol.enable_smart_prioritization()
```

### Debug e Monitoramento

```python
# Ativar logs detalhados
import logging
logging.basicConfig(level=logging.DEBUG)

# Monitor de contexto MCP
def monitor_mcp(agent):
    contextos = agent.mcp_protocol.get_context_stats()
    print(f"üìä Contextos: {contextos}")

# Monitor de conex√µes A2A
def monitor_a2a(agent):
    conexoes = agent.protocols["a2a"].get_connection_status()
    print(f"üîó Conex√µes A2A: {conexoes}")
```

---

> üéØ **Pr√≥ximos Passos**: Agora que voc√™ domina os protocolos, explore as [Melhores Pr√°ticas](melhores-praticas.md) para otimizar seus agentes!